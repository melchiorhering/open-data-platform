apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: zt-default-deny-all
spec:
  description: "Default Deny Ingress/Egress for all non-system namespaces"
  endpointSelector:
    matchExpressions:
      # Exclude system namespaces so the cluster doesn't self-destruct
      - key: io.kubernetes.pod.namespace
        operator: NotIn
        values:
          [
            "kube-system",
            "cert-manager",
            "cilium-secrets",
            "local-path-storage",
          ]

  # BLOCK INGRESS (Incoming)
  ingress: []

  # LIMIT EGRESS (Outgoing) -> Only DNS allowed
  egress:
    - toEndpoints:
        - matchLabels:
            "k8s-app": "kube-dns"
            "io.kubernetes.pod.namespace": "kube-system"
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
